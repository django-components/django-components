name: Notify Discord on Release

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Post to Discord (announcements channel)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_ANNOUNCEMENTS }}
          NAME: ${{ github.event.release.name || github.event.release.tag_name }}
          URL: ${{ github.event.release.html_url }}
          BODY: ${{ github.event.release.body }}
          USER: ${{ github.event.release.author.login }}
          REPO: ${{ github.repository }}
          TS: ${{ github.event.release.published_at }}
        run: |
          # Discord embed description limit is 4096 characters; truncate body to avoid webhook rejection
          TRUNC_SUFFIX=$'\n\n_â€¦ See release link for full changelog._'
          MAX_BODY=4000
          if [ ${#BODY} -gt "$MAX_BODY" ]; then
            BODY="${BODY:0:$MAX_BODY}${TRUNC_SUFFIX}"
          fi
          payload=$(jq -n \
            --arg name "$NAME" \
            --arg url "$URL" \
            --arg body "$BODY" \
            --arg user "$USER" \
            --arg repo "$REPO" \
            --arg timestamp "$TS" \
            '{
              "username": "GitHub Releases",
              "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
              "embeds": [
                {
                  "title": ("ðŸš€ New Release: " + $name),
                  "url": $url,
                  "description": $body,
                  "color": 2664261,
                  "author": {"name": $user},
                  "footer": {"text": $repo},
                  "timestamp": $timestamp
                }
              ]
            }')
          curl -sS -X POST -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" | cat
